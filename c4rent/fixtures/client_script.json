[
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Rent",
  "enabled": 0,
  "modified": "2025-02-14 22:25:21.287797",
  "module": "C4Rent",
  "name": "Rent",
  "script": "frappe.ui.form.on(\"Sales Invoice\", {\r\n    onload: function(frm) {\r\n    frm.doc.rent ? fetch_items(frm,frm.doc.rent) : console.log(frm.doc.rent);\r\n\t}\r\n});\r\n\r\nlet fetch_items =  (frm, rent_name) => {\r\n\tif (frm.doc.__islocal && cur_frm.doc.selling_price_list == \"Daily\") {\r\n\t\t    frm.doc.items = [];\r\n\tfrappe.call(\r\n\t\t\t{\r\n\t\t\tmethod: 'frappe.client.get_list',\r\n\t\t\targs: {\r\n\t\t\t\t\t'doctype': 'Rent Detail',\r\n\t\t\t\t\t\"parent\": \"Rent\",\r\n\t\t\t\t\t'filters': {'parent': frm.doc.rent,\r\n\t\t\t\t\t    \"returned\":0,\r\n\t\t\t\t\t},\r\n\t\t\t\t\t'fields': [\r\n\t\t\t\t\t\t'name',\r\n\t\t\t\t\t\t\"item_name\",\r\n\t\t\t\t\t\t\"item_code\",\r\n\t\t\t\t\t\t\"rate\",\r\n\t\t\t\t\t\t'income_account',\r\n\t\t\t\t\t\t\"uom\",\r\n\t\t\t\t\t\t\"qty\",\r\n\t\t\t\t\t\t\"return_qty\"\r\n\t\t\t\t\t\t\r\n\t\t\t\t\t]\r\n\t\t\t\t},\r\n\t\t\tcallback:  (r) =>{\r\n\t\t\t\tif (r.message) {\r\n\t\t\t\t         let returnedrentdata = get_item_code(frm, frm.doc.rent);\r\n\r\n\t\t\t\t\t    r.message.forEach((value, idx, arr)=>{\r\n\t\t\t\t\t   if ((value.qty - value.return_qty)>0){\r\n\t\t\t\t\t       let items = frm.add_child(\"items\");\r\n\t\t\t\t\t\titems.item_code=value.item_code;\r\n\t\t\t\t\t\titems.item_name=value.item_name;\r\n\t\t\t\t\t\titems.description=value.item_name;\r\n\t\t\t\t\t\titems.income_account='خدمة - EA';\r\n\t\t\t\t\t\titems.rate=value.rate;\r\n\t\t\t\t\t\titems.uom=value.uom;\r\n\t\t\t\t\t\titems.rent_detail = value.name;\r\n\t\t\t\t\t\titems.rent_qty = value.qty - value.return_qty;\r\n\t\t\t\t\t       \r\n\t\t\t\t\t   }\r\n\t\t\t\t\t\t\r\n\r\n\r\n\t\t\t\t\t});\r\n\t\t\t\t\tfrm.refresh_field('items');\r\n\t\t\t\t\t// frm.save()\r\n\t\t\t\t    \r\n\t\t\t\t}\r\n\t\t\t\t\r\n\t\t\t},\r\n\t\t\tfreeze: true,\r\n\t\t\tfreeze_message: __(`Filling items Table ......`)\r\n\t\t});\r\n\t}\r\n\r\n\r\n\r\n};\r\n\r\nlet get_item_code =  (frm, rent) => {\r\n\tif (frm.doc.__islocal && cur_frm.doc.selling_price_list == \"Daily\") {\r\n\t\t const desk = {\r\n   name: \"4 feet\",\r\n   rent_item: \"30 pounds\",\r\n   date: \"brown\",\r\n };\r\n\tfrappe.call(\r\n\t\t\t{\r\n\t\t\tmethod: 'frappe.client.get_list',\r\n\t\t\targs: {\r\n\t\t\t\t\t'doctype': 'Rent',\r\n\t\t\t\t\t'filters': {'name': frm.doc.rent},\r\n\t\t\t\t\t'fields': [\r\n\t\t\t\t\t\t'name',\r\n\t\t\t\t\t\t\"date\",\r\n\t\t\t\t\t]\r\n\t\t\t\t},\r\n\t\t\tcallback:  (r) =>{\r\n\t\t\t\tif (r.message) {\r\n\t\t\t\t    let date_1 = new Date(frm.doc.posting_date);\r\n                    let date_2 = new Date(r.message[0].date);\r\n                    const days = (date_1, date_2) =>{\r\n                        let difference = date_1.getTime() - date_2.getTime();\r\n                        let TotalDays = Math.ceil(difference / (1000 * 3600 * 24));\r\n                        if (TotalDays === 0){\r\n                            TotalDays = 1\r\n                        }\r\n                        return TotalDays;\r\n                        \r\n                    };\r\n                    frm.doc.items.forEach((item, idx, arr)=> {\r\n        \t\t\tcur_frm.get_field(\"items\").grid.grid_rows[idx].doc.days = days(date_1, date_2) \r\n        \t\t\tcur_frm.get_field(\"items\").grid.grid_rows[idx].doc.qty = days(date_1, date_2) * cur_frm.get_field(\"items\").grid.grid_rows[idx].doc.rent_qty;\r\n\r\n\r\n                    })\r\n\r\n\t\t\t\t}\r\n\t\t\t\t\r\n\t\t\t},\r\n\t\t});\r\n\t}\r\n\r\n\r\n};\r\n\r\n\r\nfrappe.ui.form.on('Sales Invoice',\"validate\", function(frm, cdt, cdn) {\r\n    $.each(frm.doc.items || [], function(i, d) {\r\n        if(cur_frm.doc.rent && cur_frm.doc.selling_price_list == \"Daily\"){\r\n         d.qty = d.rent_qty * d.days;\r\n    }\r\n    });\r\n});\r\n\r\nfrappe.ui.form.on(\"Rent\", \"return\", function(frm) {\r\n\tfrappe.call({\r\n\t\tmethod: \"stop_auto_repeat\",\r\n\t\tdoc:frm.doc,\r\n\t\tcallback: function(r) {\r\n\t\t\tfrm.refresh_fields();\r\n\t\t}\r\n\t});\r\n});\r\n\r\n",
  "view": "Form"
 }
]